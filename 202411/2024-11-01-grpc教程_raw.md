Title: å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-protobufåŸºç¡€protobufæ˜¯ä¸€ç§è¯­è¨€æ— å…³ã€å¹³å°æ— å…³çš„å¯æ‰©å±•çš„åºåˆ—åŒ–åè®®ã€‚gRPC - æ˜é‡‘

URL Source: https://juejin.cn/post/7191008929986379836

Markdown Content:
æœ¬ç¯‡ä¸ºã€å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹ã€‘ç³»åˆ—ç¬¬ä¸€ç¯‡

ç¬¬ä¸€ç¯‡ï¼š[protobufåŸºç¡€](https://juejin.cn/post/7191008929986379836 "https://juejin.cn/post/7191008929986379836") ğŸ‘ˆ

ç¬¬äºŒç¯‡ï¼š[é€šä¿¡æ¨¡å¼](https://juejin.cn/post/7192793369523781691 "https://juejin.cn/post/7192793369523781691")

ç¬¬ä¸‰ç¯‡ï¼š[æ‹¦æˆªå™¨](https://juejin.cn/post/7196150790367805477 "https://juejin.cn/post/7196150790367805477")

ç¬¬å››ç¯‡ï¼š[é”™è¯¯å¤„ç†](https://juejin.cn/post/7199443332086628412 "https://juejin.cn/post/7199443332086628412")

ç¬¬äº”ç¯‡ï¼š[metadata](https://juejin.cn/post/7202409558592782373 "https://juejin.cn/post/7202409558592782373")

ç¬¬å…­ç¯‡ï¼š[è¶…æ—¶æ§åˆ¶](https://juejin.cn/post/7208239217943969847 "https://juejin.cn/post/7208239217943969847")

ç¬¬ä¸ƒç¯‡ï¼š[å®‰å…¨](https://juejin.cn/post/7221343753696624699 "https://juejin.cn/post/7221343753696624699")

ç¬¬å…«ç¯‡ï¼š[ç”¨æˆ·è®¤è¯](https://juejin.cn/post/7229145941399027771 "https://juejin.cn/post/7229145941399027771")

ç¬¬ä¹ç¯‡ï¼š[æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡](https://juejin.cn/post/7251231773673406520 "https://juejin.cn/post/7251231773673406520")

* * *

`gRPC`æ˜¯è°·æ­Œå¼€æºçš„ä¸€æ¬¾**é«˜æ€§èƒ½**ã€æ”¯æŒå¤šç§å¼€å‘è¯­è¨€çš„æœåŠ¡æ¡†æ¶ï¼Œå¯¹äºä¸€ä¸ªrpcæˆ‘ä»¬å…³æ³¨å¦‚ä¸‹å‡ æ–¹é¢ï¼š

**åºåˆ—åŒ–åè®®**ã€‚`gRPC`ä½¿ç”¨`protobuf`ï¼Œé¦–å…ˆä½¿ç”¨protobufå®šä¹‰æœåŠ¡ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä»£ç ã€‚å› ä¸ºpbæ˜¯è·¨è¯­è¨€çš„ï¼Œå› æ­¤å³ä½¿æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¯­è¨€å¹¶ä¸ä¸€è‡´ä¹Ÿæ˜¯å¯ä»¥äº’ç›¸åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„

**ç½‘ç»œä¼ è¾“å±‚**ã€‚gRPCä½¿ç”¨`http2.0`åè®®ï¼Œ`http2.0`ç›¸æ¯”äº`HTTP 1.x` ï¼Œå¤§å¹…åº¦çš„æå‡äº† web æ€§èƒ½ã€‚

![Image 1: image-20220328002124007-8398087.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96360d77459d47d083fd50601d85b710~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

Protobuf IDL
------------

æ‰€è°“åºåˆ—åŒ–é€šä¿—æ¥è¯´å°±æ˜¯æŠŠå†…å­˜çš„ä¸€æ®µæ•°æ®è½¬åŒ–æˆäºŒè¿›åˆ¶å¹¶å­˜å‚¨æˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œè€Œè¯»å–ç£ç›˜æˆ–å¦ä¸€ç«¯æ”¶åˆ°åå¯ä»¥åœ¨å†…å­˜ä¸­é‡å»ºè¿™æ®µæ•°æ®

1ã€`protobuf`åè®®æ˜¯è·¨è¯­è¨€è·¨å¹³å°çš„åºåˆ—åŒ–åè®®ã€‚

2ã€`protobuf`æœ¬èº«å¹¶ä¸æ˜¯å’Œ`gRPC`ç»‘å®šçš„ã€‚å®ƒä¹Ÿå¯ä»¥è¢«ç”¨äºéRPCåœºæ™¯ï¼Œå¦‚å­˜å‚¨ç­‰

`json`ã€` xml`éƒ½æ˜¯ä¸€ç§åºåˆ—åŒ–çš„æ–¹å¼ï¼Œåªæ˜¯ä»–ä»¬ä¸éœ€è¦æå‰é¢„å®šä¹‰idlï¼Œä¸”å…·å¤‡å¯è¯»æ€§ï¼Œå½“ç„¶ä»–ä»¬ä¼ è¾“çš„ä½“ç§¯ä¹Ÿå› æ­¤è¾ƒå¤§ï¼Œå¯ä»¥è¯´æ˜¯å„æœ‰ä¼˜åŠ£

æ‰€ä»¥å…ˆæ¥ä»‹ç»ä¸‹`protobuf`çš„idlæ€ä¹ˆå†™ã€‚`protobuf`æœ€æ–°ç‰ˆæœ¬ä¸º`proto3`ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜ï¼š[protobuf.dev/programmingâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fprotobuf.dev%2Fprogramming-guides%2Fproto3%2F "https://protobuf.dev/programming-guides/proto3/")

### å®šä¹‰æ¶ˆæ¯ç±»å‹

`protobuf`é‡Œæœ€åŸºæœ¬çš„ç±»å‹å°±æ˜¯`message`ï¼Œæ¯ä¸€ä¸ª`message`éƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­—æ®µ(`field`)ï¼Œå…¶ä¸­å­—æ®µåŒ…å«å¦‚ä¸‹å…ƒç´ 

![Image 2: protobufç±»å‹æ ¼å¼.drawio.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68fc9a192b344244aa3dd90eacc4f3a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

*   ç±»å‹ï¼šç±»å‹ä¸ä»…å¯ä»¥æ˜¯æ ‡é‡ç±»å‹ï¼ˆ`int`ã€`string`ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤åˆç±»å‹ï¼ˆ`enum`ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–`message`
    
*   å­—æ®µåï¼šå­—æ®µåæ¯”è¾ƒæ¨èçš„æ˜¯ä½¿ç”¨ä¸‹åˆ’çº¿/åˆ†éš”åç§°
    
*   å­—æ®µç¼–å·ï¼šä¸€ä¸ªmessageå†…æ¯ä¸€ä¸ªå­—æ®µç¼–å·éƒ½å¿…é¡»å”¯ä¸€çš„ï¼Œåœ¨ç¼–ç åå…¶å®ä¼ é€’çš„æ˜¯è¿™ä¸ªç¼–å·è€Œä¸æ˜¯å­—æ®µå
    
*   å­—æ®µè§„åˆ™ï¼šæ¶ˆæ¯å­—æ®µå¯ä»¥æ˜¯ä»¥ä¸‹å­—æ®µä¹‹ä¸€
    
    *   `singular`ï¼šæ ¼å¼æ­£ç¡®çš„æ¶ˆæ¯å¯ä»¥æœ‰é›¶ä¸ªæˆ–ä¸€ä¸ªå­—æ®µï¼ˆä½†ä¸èƒ½è¶…è¿‡ä¸€ä¸ªï¼‰ã€‚ä½¿ç”¨ proto3 è¯­æ³•æ—¶ï¼Œå¦‚æœæœªä¸ºç»™å®šå­—æ®µæŒ‡å®šå…¶ä»–å­—æ®µè§„åˆ™ï¼Œåˆ™è¿™æ˜¯é»˜è®¤å­—æ®µè§„åˆ™
        
    *   `optional`ï¼šä¸ `singular` ç›¸åŒï¼Œä¸è¿‡æ‚¨å¯ä»¥æ£€æŸ¥è¯¥å€¼æ˜¯å¦æ˜ç¡®è®¾ç½®
        
    *   `repeated`ï¼šåœ¨æ ¼å¼æ­£ç¡®çš„æ¶ˆæ¯ä¸­ï¼Œæ­¤å­—æ®µç±»å‹å¯ä»¥é‡å¤é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚ç³»ç»Ÿä¼šä¿ç•™é‡å¤å€¼çš„é¡ºåº
        
    *   `map`ï¼šè¿™æ˜¯ä¸€ä¸ªæˆå¯¹çš„é”®å€¼å¯¹å­—æ®µ
        
*   ä¿ç•™å­—æ®µï¼šä¸ºäº†é¿å…å†æ¬¡ä½¿ç”¨åˆ°å·²ç§»é™¤çš„å­—æ®µå¯ä»¥è®¾å®šä¿ç•™å­—æ®µã€‚å¦‚æœä»»ä½•æœªæ¥ç”¨æˆ·å°è¯•ä½¿ç”¨è¿™äº›å­—æ®µæ ‡è¯†ç¬¦ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™
    

### æ ‡é‡å€¼ç±»

æ ‡é‡ç±»å‹ä¼šæ¶‰åŠåˆ°ä¸åŒè¯­è¨€å’Œç¼–ç æ–¹å¼ï¼Œåç»­æœ‰æœºä¼šæ·±å…¥è®²

| .proto Type | Go Type | Notes |
| --- | --- | --- |
| double | float64 |  |
| float | float32 |  |
| int32 | int32 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚å¯¹è´Ÿæ•°çš„ç¼–ç æ•ˆç‡ä½ä¸‹ - å¦‚æœæ‚¨çš„å­—æ®µå¯èƒ½åŒ…å«è´Ÿå€¼ï¼Œè¯·æ”¹ç”¨ sint32ã€‚ |
| int64 | int64 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚å¯¹è´Ÿæ•°çš„ç¼–ç æ•ˆç‡ä½ä¸‹ - å¦‚æœå­—æ®µå¯èƒ½æœ‰è´Ÿå€¼ï¼Œè¯·æ”¹ç”¨ sint64ã€‚ |
| uint32 | uint32 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚ |
| uint64 | uint64 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚ |
| sint32 | int32 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚æœ‰ç¬¦å·æ•´æ•°å€¼ã€‚ä¸å¸¸è§„ int32 ç›¸æ¯”ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æ›´é«˜æ•ˆåœ°å¯¹è´Ÿæ•°è¿›è¡Œç¼–ç ã€‚ |
| sint64 | int64 | ä½¿ç”¨å¯å˜é•¿åº¦çš„ç¼–ç ã€‚æœ‰ç¬¦å·æ•´æ•°å€¼ã€‚ä¸å¸¸è§„ int64 ç›¸æ¯”ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æ›´é«˜æ•ˆåœ°å¯¹è´Ÿæ•°è¿›è¡Œç¼–ç ã€‚ |
| fixed32 | uint32 | å§‹ç»ˆä¸º 4 ä¸ªå­—èŠ‚ã€‚å¦‚æœå€¼é€šå¸¸å¤§äº 2^28ï¼Œåˆ™æ¯” uint32 æ›´é«˜æ•ˆã€‚ |
| fixed64 | uint64 | å§‹ç»ˆä¸º 8 ä¸ªå­—èŠ‚ã€‚å¦‚æœå€¼é€šå¸¸å¤§äº 2^56ï¼Œåˆ™æ¯” uint64 æ›´é«˜æ•ˆã€‚ |
| sfixed32 | int32 | å§‹ç»ˆä¸º 4 ä¸ªå­—èŠ‚ã€‚ |
| sfixed64 | int64 | å§‹ç»ˆä¸º 8 ä¸ªå­—èŠ‚ã€‚ |
| bool | bool |  |
| string | string | å­—ç¬¦ä¸²å¿…é¡»å§‹ç»ˆåŒ…å« UTF-8 ç¼–ç æˆ– 7 ä½ ASCII æ–‡æœ¬ï¼Œå¹¶ä¸”é•¿åº¦ä¸å¾—è¶…è¿‡ 232ã€‚ |
| bytes | \[\]byte | å¯ä»¥åŒ…å«ä»»æ„é•¿åº¦çš„ 2^32 å­—èŠ‚ã€‚ |

### å¤åˆç±»å‹

#### æ•°ç»„

```
message SearchResponse {
  repeated Result results = 1;
}

message Result {
  string url = 1;
  string title = 2;
  repeated string snippets = 3;
}
```

#### æšä¸¾

```
message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
  enum Corpus {
    UNIVERSAL = 0;
    WEB = 1;
    IMAGES = 2;
    LOCAL = 3;
    NEWS = 4;
    PRODUCTS = 5;
    VIDEO = 6;
  }
  Corpus corpus = 4;
}
```

#### æœåŠ¡

å®šä¹‰çš„methodä»…èƒ½æœ‰ä¸€ä¸ªå…¥å‚å’Œå‡ºå‚æ•°ã€‚å¦‚æœéœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°éœ€è¦å®šä¹‰æˆmessage

```
service SearchService {
  rpc Search(SearchRequest) returns (SearchResponse);
}
```

### ä½¿ç”¨å…¶ä»–æ¶ˆæ¯ç±»å‹

ä½¿ç”¨importå¼•ç”¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶çš„pb

```
syntax = "proto3";

import "google/protobuf/wrappers.proto";

package ecommerce;

message Order {
  string id = 1;
  repeated string items = 2;
  string description = 3;
  float price = 4;
  google.protobuf.StringValue destination = 5;
}
```

protocä½¿ç”¨
--------

protocå°±æ˜¯protobufçš„ç¼–è¯‘å™¨ï¼Œå®ƒæŠŠprotoæ–‡ä»¶ç¼–è¯‘æˆä¸åŒçš„è¯­è¨€

### ğŸ“– å®‰è£…

[grpc.io/docs/protocâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgrpc.io%2Fdocs%2Fprotoc-installation%2F "https://grpc.io/docs/protoc-installation/")

*   Linux, using `apt` or `apt-get`, for example:
    
    ```
    $ apt install -y protobuf-compiler
    $ protoc --version  # Ensure compiler version is 3+
    ```
    
*   MacOS, using [Homebrew](https://link.juejin.cn/?target=https%3A%2F%2Fbrew.sh%2F "https://brew.sh/"):
    
    ```
    $ brew install protobuf
    $ protoc --version  # Ensure compiler version is 3+
    ```
    

### ğŸ“– ä½¿ç”¨

```
$ protoc --help
Usage: protoc [OPTION] PROTO_FILES

  -IPATH, --proto_path=PATH   æŒ‡å®šæœç´¢è·¯å¾„
  --plugin=EXECUTABLE:
  
  ....
 
  --cpp_out=OUT_DIR           Generate C++ header and source.
  --csharp_out=OUT_DIR        Generate C# source file.
  --java_out=OUT_DIR          Generate Java source file.
  --js_out=OUT_DIR            Generate JavaScript source.
  --objc_out=OUT_DIR          Generate Objective C header and source.
  --php_out=OUT_DIR           Generate PHP source file.
  --python_out=OUT_DIR        Generate Python source file.
  --ruby_out=OUT_DIR          Generate Ruby source file
  
   @<filename>                protoæ–‡ä»¶çš„å…·ä½“ä½ç½®
```

#### 1.æœç´¢è·¯å¾„å‚æ•°

ç¬¬ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°å°±æ˜¯`æœç´¢è·¯å¾„å‚æ•°`ï¼Œå³ä¸Šè¿°å±•ç¤ºçš„`-IPATH, --proto_path=PATH`ã€‚å®ƒè¡¨ç¤ºçš„æ˜¯æˆ‘ä»¬è¦åœ¨å“ªä¸ªè·¯å¾„ä¸‹æœç´¢`.proto`æ–‡ä»¶ï¼Œè¿™ä¸ªå‚æ•°æ—¢å¯ä»¥ç”¨`-I`æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`--proto_path=`æŒ‡å®šã€‚

å¦‚æœä¸æŒ‡å®šè¯¥å‚æ•°ï¼Œåˆ™é»˜è®¤åœ¨**å½“å‰è·¯å¾„**ä¸‹è¿›è¡Œæœç´¢ï¼›å¦å¤–ï¼Œè¯¥å‚æ•°ä¹Ÿå¯ä»¥æŒ‡å®šå¤šæ¬¡ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŒ‡å®š**å¤šä¸ªè·¯å¾„**è¿›è¡Œæœç´¢ã€‚

#### 2.è¯­è¨€æ’ä»¶å‚æ•°

è¯­è¨€å‚æ•°å³ä¸Šè¿°çš„`--cpp_out=`ï¼Œ`--python_out=`ç­‰ï¼Œprotocæ”¯æŒçš„è¯­è¨€é•¿è¾¾13ç§ï¼Œä¸”éƒ½æ˜¯æ¯”è¾ƒå¸¸è§çš„

è¿è¡Œhelpå‡ºç°çš„è¯­è¨€å‚æ•°ï¼Œè¯´æ˜protocæœ¬èº«å·²ç»å†…ç½®è¯¥è¯­è¨€å¯¹åº”çš„ç¼–è¯‘æ’ä»¶ï¼Œæˆ‘ä»¬æ— éœ€å®‰è£…

| Language | Generated Code | Source |
| --- | --- | --- |
| C++ (include C++ runtime and protoc) | [C++](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fcpp-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/cpp-generated#invocation") | [src](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fsrc "https://github.com/protocolbuffers/protobuf/blob/main/src") |
| Java | [Java](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fjava-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/java-generated#invocation") | [java](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fjava "https://github.com/protocolbuffers/protobuf/blob/main/java") |
| Python | [Python](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fpython-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/python-generated#invocation") | [python](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fpython "https://github.com/protocolbuffers/protobuf/blob/main/python") |
| Objective-C | [Objective-C](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fobjective-c-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/objective-c-generated#invocation") | [objectivec](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fobjectivec "https://github.com/protocolbuffers/protobuf/blob/main/objectivec") |
| C# | [C#](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fcsharp-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/csharp-generated#invocation") | [csharp](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fcsharp "https://github.com/protocolbuffers/protobuf/blob/main/csharp") |
| Ruby | [Ruby](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fruby-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/ruby-generated#invocation") | [ruby](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fruby "https://github.com/protocolbuffers/protobuf/blob/main/ruby") |
| PHP | [PHP](https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fphp-generated%23invocation "https://developers.google.com/protocol-buffers/docs/reference/php-generated#invocation") | [php](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Fblob%2Fmain%2Fphp "https://github.com/protocolbuffers/protobuf/blob/main/php") |

ä¸‹é¢çš„è¯­è¨€æ˜¯ç”±googleç»´æŠ¤ï¼Œé€šè¿‡protocçš„æ’ä»¶æœºåˆ¶æ¥å®ç°ï¼Œæ‰€ä»¥ä»“åº“å•ç‹¬ç»´æŠ¤

*   [Dart](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fprotobuf.dart "https://github.com/google/protobuf.dart")
*   [Go](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf-go "https://github.com/protocolbuffers/protobuf-go")

#### 3.protoæ–‡ä»¶ä½ç½®å‚æ•°

protoæ–‡ä»¶ä½ç½®å‚æ•°å³ä¸Šè¿°çš„`@<filename>`å‚æ•°ï¼ŒæŒ‡å®šäº†æˆ‘ä»¬protoæ–‡ä»¶çš„å…·ä½“ä½ç½®ï¼Œå¦‚`proto1/greeter/greeter.proto`ã€‚

### ğŸ“– è¯­è¨€æ’ä»¶

#### âœ¨ golangæ’ä»¶

éå†…ç½®çš„è¯­è¨€æ”¯æŒå°±å¾—è‡ªå·±å•ç‹¬å®‰è£…è¯­è¨€æ’ä»¶ï¼Œæ¯”å¦‚`--go_out=`å¯¹åº”çš„æ˜¯`protoc-gen-go`ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

```
# æœ€æ–°ç‰ˆ
$ go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

# æŒ‡å®šç‰ˆæœ¬
$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.3.0
```

å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç”Ÿæˆä»£ç 

```
$ protoc --proto_path=src --go_out=out --go_opt=paths=source_relative foo.proto bar/baz.proto
```

##### æ³¨æ„

`protoc-gen-go`è¦æ±‚pbæ–‡ä»¶å¿…é¡»æŒ‡å®šgoåŒ…çš„è·¯å¾„ï¼Œå³

```
option go_package = "liangwt/note/grpc/example/ecommerce";
```

##### \--go\_out

æŒ‡å®šgoä»£ç ç”Ÿæˆçš„åŸºæœ¬è·¯å¾„

##### \--go\_optï¼šè®¾å®šæ’ä»¶å‚æ•°

`protoc-gen-go`æä¾›äº† `--go_opt` æ¥ä¸ºå…¶æŒ‡å®šå‚æ•°ï¼Œå¹¶å¯ä»¥è®¾ç½®å¤šä¸ª

1ã€å¦‚æœä½¿ç”¨ `paths=import` , ç”Ÿæˆçš„æ–‡ä»¶ä¼šæŒ‰`go_package`è·¯å¾„æ¥ç”Ÿæˆï¼Œå½“ç„¶æ˜¯åœ¨`--go_out`ç›®å½•ä¸‹ï¼Œå³

```
$go_out/$go_package/pb_filename.pb.go
```

2ã€å¦‚æœä½¿ç”¨ `paths=source_relative` ï¼Œ å°±åœ¨å½“å‰pbæ–‡ä»¶åŒè·¯å¾„ä¸‹ç”Ÿæˆä»£ç ã€‚æ³¨æ„pbçš„ç›®å½•ä¹Ÿè¢«åŒ…å«è¿›å»äº†ã€‚å³

```
$go_out/$pb_filedir/$pb_filename.pb.go
```

#### âœ¨ grpc goæ’ä»¶

åœ¨`google.golang.org/protobuf`ä¸­ï¼Œ`protoc-gen-go`çº¯ç²¹ç”¨æ¥ç”Ÿæˆpbåºåˆ—åŒ–ç›¸å…³çš„æ–‡ä»¶ï¼Œä¸å†æ‰¿è½½gRPCä»£ç ç”ŸæˆåŠŸèƒ½ã€‚

ç”ŸæˆgRPCç›¸å…³ä»£ç éœ€è¦å®‰è£…grpc-goç›¸å…³çš„æ’ä»¶`protoc-gen-go-grpc`

```
 $ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
```

æ‰§è¡Œcode genå‘½ä»¤

```
$ protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    routeguide/route_guide.proto
```

##### \--go-grpc\_out

æŒ‡å®šgrpc goä»£ç ç”Ÿæˆçš„åŸºæœ¬è·¯å¾„

å‘½ä»¤ä¼šäº§ç”Ÿå¦‚ä¸‹æ–‡ä»¶

*   `route_guide.pb.go`, `protoc-gen-go`çš„äº§å‡ºç‰©ï¼ŒåŒ…å«æ‰€æœ‰ç±»å‹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç 
    
*   `route_guide_grpc.pb.go`, `protoc-gen-go-grpc`çš„äº§å‡ºç‰©ï¼ŒåŒ…å«
    
    *   å®šä¹‰åœ¨ `RouteGuide` serviceä¸­çš„ç”¨æ¥ç»™clientè°ƒç”¨çš„æ¥å£å®šä¹‰
    *   å®šä¹‰åœ¨ `RouteGuide` serviceä¸­çš„ç”¨æ¥ç»™æœåŠ¡ç«¯å®ç°çš„æ¥å£å®šä¹‰

##### \--go-grpc\_opt

å’Œ`protoc-gen-go`ç±»ä¼¼ï¼Œ`protoc-gen-go-grpc`æä¾› `--go-grpc_opt` æ¥æŒ‡å®šå‚æ•°ï¼Œå¹¶å¯ä»¥è®¾ç½®å¤šä¸ª

#### âœ¨ `github.com/golang/protobuf` vs `google.golang.org/protobuf`

`github.com/golang/protobuf`è™½ç„¶å·²ç»åºŸå¼ƒï¼Œä½†ç½‘ä¸Šæœç´¢æ—¶ç»å¸¸è¿˜èƒ½æœåˆ°ï¼Œæ–¹ä¾¿ç†è§£æ•´ç†ä¸¤è€…åŒºåˆ«ã€‚

|  | `google.golang.org/protobuf` | `github.com/golang/protobuf` |
| --- | --- | --- |
| ä»£ç å·®å¼‚ | æ–°ï¼›æ¨èä½¿ç”¨ | æ—§ï¼›  
`v1.4.0`åä»…æ˜¯`google.golang.org/protobuf`çš„åŒ…è£… |
| åŠŸèƒ½å·®å¼‚ | åŠŸèƒ½çº¯ç²¹ï¼š  
åªç”Ÿæˆpbåºåˆ—åŒ–ç›¸å…³çš„æ–‡ä»¶  
ç”ŸæˆgRPCç›¸å…³ä»£ç éœ€è¦ä½¿ç”¨`grpc-go`æ’ä»¶`protoc-gen-go-grpc` | åŒæ—¶ç”Ÿæˆpbå’ŒgRPCç›¸å…³ä»£ç  |
| ç”¨æ³•å·®å¼‚ | `protoc --go_out=. --go_opt=paths=source_relative routeguide/route_guide.proto` | `protoc --go_out=plugins=grpc,paths=import:. routeguide/route_guide.proto` |

##### ä»£ç å·®å¼‚

è¿™ä¸¤ä¸ªåº“ï¼Œ`google.golang.org/protobuf`æ˜¯`github.com/golang/protobuf`çš„å‡çº§ç‰ˆæœ¬ï¼Œ`v1.4.0`ä¹‹å`github.com/golang/protobuf`ä»…æ˜¯`google.golang.org/protobuf`çš„åŒ…è£…

##### åŠŸèƒ½å·®å¼‚

`google.golang.org/protobuf`ï¼Œçº¯ç²¹ç”¨æ¥ç”Ÿæˆpbåºåˆ—åŒ–ç›¸å…³çš„æ–‡ä»¶ï¼Œä¸å†æ‰¿è½½gRPCä»£ç ç”ŸæˆåŠŸèƒ½ã€‚ç”ŸæˆgRPCç›¸å…³ä»£ç éœ€è¦å®‰è£…grpc-goç›¸å…³çš„æ’ä»¶`protoc-gen-go-grpc`

`github.com/golang/protobuf `ï¼Œå¯ä»¥åŒæ—¶ç”Ÿæˆpbå’ŒgRPCç›¸å…³ä»£ç çš„

##### ç”¨æ³•å·®å¼‚

`google.golang.org/protobuf`

```
$ protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    routeguide/route_guide.proto
```

`github.com/golang/protobuf`

```
$ protoc --go_out=plugins=grpc,paths=import:. \
    routeguide/route_guide.proto
```

`--go_out`çš„å†™æ³•æ˜¯ï¼Œå‚æ•°ä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œæœ€ååŠ ä¸Šå†’å·æ¥æŒ‡å®šä»£ç çš„ç”Ÿæˆä½ç½®ï¼Œæ¯”å¦‚`--go_out=plugins=grpc,paths=import:.`

`--go_out`ä¸»è¦çš„ä¸¤ä¸ªå‚æ•°ä¸º`plugins` å’Œ `paths`ï¼Œåˆ†åˆ«è¡¨ç¤ºç”ŸæˆGoä»£ç æ‰€ä½¿ç”¨çš„æ’ä»¶ï¼Œä»¥åŠç”Ÿæˆçš„Goä»£ç çš„ä½ç½®ã€‚

`plugins`å‚æ•°æœ‰ä¸å¸¦grpcå’Œå¸¦grpcä¸¤ç§ï¼ˆåº”è¯¥è¿˜æœ‰å…¶å®ƒçš„ï¼Œç›®å‰çŸ¥é“çš„æœ‰è¿™ä¸¤ç§ï¼‰ï¼Œä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼Œå¸¦grpcçš„ä¼šå¤šä¸€äº›è·ŸgRPCç›¸å…³çš„ä»£ç ï¼Œå®ç°gRPCé€šä¿¡

**`paths`å‚æ•°**æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œåˆ†åˆ«æ˜¯ `import` å’Œ `source_relative`ï¼Œé»˜è®¤ä¸º import

*   `import`è¡¨ç¤ºæŒ‰ç…§ç”Ÿæˆçš„Goä»£ç çš„åŒ…çš„å…¨è·¯å¾„å»åˆ›å»ºç›®å½•å±‚çº§
*   `source_relative` è¡¨ç¤ºæŒ‰ç…§ **protoæºæ–‡ä»¶çš„ç›®å½•å±‚çº§**å»åˆ›å»ºGoä»£ç çš„ç›®å½•å±‚çº§ï¼Œå¦‚æœç›®å½•å·²å­˜åœ¨åˆ™ä¸ç”¨åˆ›å»ºã€‚

**æ€»ä¹‹ï¼Œç”¨`google.golang.org/protobuf`å°±å¯¹äº†ï¼**

Buf å·¥å…·
------

å¯ä»¥çœ‹åˆ°ä½¿ç”¨protocçš„æ—¶å€™ï¼Œå½“ä½¿ç”¨çš„æ’ä»¶é€æ¸å˜å¤šï¼Œæ’ä»¶å‚æ•°é€æ¸å˜å¤šæ—¶ï¼Œå‘½ä»¤è¡Œæ‰§è¡Œå¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿å’Œç›´è§‚ã€‚ä¾‹å¦‚åé¢ä½¿ç”¨åˆ°äº†grpc-gateway+swaggeræ’ä»¶æ—¶

```
$ protoc -I ./pb \
  --go_out ./ecommerce --go_opt paths=source_relative \
  --go-grpc_out ./ecommerce --go-grpc_opt paths=source_relative \
  --grpc-gateway_out ./ecommerce --grpc-gateway_opt paths=source_relative \
  --openapiv2_out ./doc --openapiv2_opt logtostderr=true \
  ./pb/ecommerce/v1/product.proto
```

å…¶æ¬¡ä¾èµ–æŸäº›å¤–éƒ¨çš„protobufæ–‡ä»¶æ—¶ï¼Œåªèƒ½é€šè¿‡æ‹·è´åˆ°æœ¬åœ°çš„æ–¹å¼ï¼Œä¹Ÿä¸å¤Ÿæ–¹ä¾¿

å› æ­¤è¯ç”Ÿäº†[âœ¨ Buf](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbufbuild%2Fbuf "https://github.com/bufbuild/buf") è¿™ä¸ªé¡¹ç›®ï¼Œå®ƒé™¤äº†èƒ½è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè¿˜æœ‰é¢å¤–çš„åŠŸèƒ½

*   ä¸å…¼å®¹ç ´åæ£€æŸ¥
*   linter
*   é›†ä¸­å¼çš„ç‰ˆæœ¬ç®¡ç†

### åˆå§‹åŒ–æ¨¡å—

åœ¨pbæ–‡ä»¶çš„æ ¹ç›®å½•æ‰§è¡Œï¼Œä¸ºè¿™ä¸ªpbç›®å½•åˆ›å»ºä¸€ä¸ªbufçš„æ¨¡å—ã€‚æ­¤åä¾¿å¯ä»¥ä½¿ç”¨bufçš„å„ç§å‘½ä»¤æ¥ç®¡ç†è¿™ä¸ªbufæ¨¡å—äº†

```
$ buf mod init
```

æ­¤æ—¶ä¼šåœ¨æ ¹ç›®å½•å¤šå‡ºä¸€ä¸ª`buf.yaml`æ–‡ä»¶ï¼Œå†…å®¹ä¸º

```
# buf.yaml
version: v1
breaking:
  use:
    - FILE
lint:
  use:
    - DEFAULT
```

### Lint pbæ–‡ä»¶

```
$ buf lint
ecommerce/v1/product.proto:10:9:Service name "ServiceOrderManagement" should be suffixed with "Service".
ecommerce/v1/product.proto:11:18:RPC request type "getOrderReq" should be named "GetOrderRequest" or "ServiceOrderManagementGetOrderRequest".
```

è°ƒæ•´lintè§„åˆ™

```
 # buf.yaml
 version: v1
 breaking:
   use:
     - FILE
 lint:
   use:
     - DEFAULT
+  except:
+    - PACKAGE_VERSION_SUFFIX
+    - FIELD_LOWER_SNAKE_CASE
+    - SERVICE_SUFFIX
```

### ç”Ÿæˆä»£ç 

æ’ä»¶ï¼šå’Œä½¿ç”¨`protoc`ä¸€æ ·ï¼Œè¯¥è£…çš„æ’ä»¶ä¸€æ ·è¦è£…

**æ’ä»¶æ¨¡ç‰ˆ**

åˆ›å»ºä¸€ä¸ª[`buf.gen.yaml`](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.buf.build%2Fconfiguration%2Fv1%2Fbuf-gen-yaml "https://docs.buf.build/configuration/v1/buf-gen-yaml") ï¼Œå®ƒæ˜¯bufç”Ÿæˆä»£ç çš„é…ç½®ã€‚ä¸Šé¢çš„`protoc`åŒç­‰åŠŸèƒ½çš„`buf.gen.yaml`å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼Œç›¸å¯¹protocæ›´åŠ ç›´è§‚

```
# buf.gen.yaml
version: v1
plugins:
  - plugin: go
    out: ecommerce
    opt:
      - paths=source_relative
  - plugin: go-grpc
    out: ecommerce
    opt:
      - paths=source_relative
  - name: grpc-gateway
    out: ecommerce
    opt:
      - paths=source_relative
      - generate_unbound_methods=true
  - name: openapiv2
    out: doc
    opt:
      - logtostderr=true
```

**ç”Ÿæˆä»£ç **

```
buf generate pb
```

`buf generate` å‘½ä»¤å°†ä¼š

*   æœç´¢æ¯ä¸€ä¸ª`buf.yaml`é…ç½®é‡Œçš„æ‰€æœ‰`protobuf`æ–‡ä»¶
*   å¤åˆ¶æ‰€æœ‰`protobuf`æ–‡ä»¶åˆ°å†…å­˜
*   ç¼–è¯‘æ‰€æœ‰`protobuf`æ–‡ä»¶
*   æ‰§è¡Œæ¨¡ç‰ˆæ–‡ä»¶é‡Œçš„æ¯ä¸€ä¸ªæ’ä»¶

### æ·»åŠ ä¾èµ–

åœ¨ä½¿ç”¨grpc-gatewayæ—¶ä¾èµ–äº†[`google.api.http`](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgoogleapis%2Fgoogleapis%2Fblob%2Fmaster%2Fgoogle%2Fapi%2Fhttp.proto%23L46 "https://github.com/googleapis/googleapis/blob/master/google/api/http.proto#L46")ï¼Œåœ¨ä¸ä½¿ç”¨`buf`çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¤åˆ¶`.proto`åˆ°æœ¬åœ°ã€‚

`buf`ä¸ºæˆ‘ä»¬æä¾›äº† [**Buf Schema Registry (BSR)**](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.buf.build%2Fbsr%2Foverview "https://docs.buf.build/bsr/overview")ï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨å…¶ä»–äººå‘å¸ƒçš„æ¨¡å—ï¼Œä¹Ÿå¯ä»¥æŠŠæˆ‘ä»¬è‡ªå·±çš„æ¨¡å—å‘å¸ƒåˆ°`BSR`

åœ¨æ¨¡å—çš„æ–‡ä»¶é‡Œå£°æ˜ä¾èµ–é¡¹

```
 # buf.yaml
 version: v1
 breaking:
   use:
     - FILE
 lint:
   use:
     - DEFAULT
+deps:
+  - buf.build/googleapis/googleapis
```

ç„¶åæ‰§è¡Œ

```
buf mod update
```

`buf mod update` æŠŠä½ æ‰€æœ‰çš„ `deps` æ›´æ–°åˆ°æœ€æ–°ç‰ˆã€‚å¹¶ä¸”ä¼šç”Ÿæˆ `buf.lock` æ¥å›ºå®šç‰ˆæœ¬

```
# Generated by buf. DO NOT EDIT.
version: v1
deps:
  - remote: buf.build
    owner: googleapis
    repository: googleapis
    commit: 75b4300737fb4efca0831636be94e517
```

æ­¤æ—¶æ‰§è¡Œ`buf generate pb` å³ä½¿æœ¬åœ°æ²¡æœ‰ä¾èµ–ï¼Œä¹Ÿä¸ä¼šå†æŠ¥é”™ç¼ºå°‘ä¾èµ–äº†

å‚è€ƒ
--

*   [Buf å®˜æ–¹æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.buf.build%2Fintroduction "https://docs.buf.build/introduction")
*   [Protocol Buffers Documentation](https://link.juejin.cn/?target=https%3A%2F%2Fprotobuf.dev%2F "https://protobuf.dev/")

* * *

> âœ¨ å¾®ä¿¡å…¬ä¼—å·ã€**å‡‰å‡‰çš„çŸ¥è¯†åº“**ã€‘åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨è·å–æœ€æ–°æœ€æœ‰ç”¨çš„åç«¯çŸ¥è¯† âœ¨
